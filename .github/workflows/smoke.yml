name: Smoke

on:
  pull_request:
    branches:
    - main

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: grindlab_test
        ports:
        - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Check out repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'

    - name: Install backend dependencies
      shell: bash
      run: |
        python -m venv backend/.venv
        source backend/.venv/bin/activate
        pip install --upgrade pip setuptools wheel
        if [ -f backend/requirements.txt ]; then
          pip install --no-cache-dir -r backend/requirements.txt
        else
          pip install fastapi uvicorn sqlalchemy pydantic httpx python-multipart PyJWT
        fi

    - name: Reset database
      working-directory: backend
      shell: bash
      env:
        DB_URL: postgresql://postgres:postgres@localhost:5432/grindlab_test
      run: |
        source .venv/bin/activate
        python scripts/reset_db.py

    - name: Start backend
      working-directory: backend
      shell: bash
      env:
        DB_URL: postgresql://postgres:postgres@localhost:5432/grindlab_test
      run: |
        source .venv/bin/activate
        python -m uvicorn app.main:app --host 127.0.0.1 --port 8000 > /tmp/uvicorn.log 2>&1 &
        echo $! > /tmp/uvicorn.pid

    - name: Wait for backend health
      shell: bash
      run: |
        for i in {1..60}; do
          if curl -fsS http://127.0.0.1:8000/health >/dev/null; then
            exit 0
          fi
          sleep 1
        done
        echo "Backend did not become ready" >&2
        if [ -f /tmp/uvicorn.log ]; then
          echo "--- uvicorn log ---"
          cat /tmp/uvicorn.log
        fi
        exit 1

    - name: Run smoke journey
      working-directory: backend
      shell: bash
      run: |
        source .venv/bin/activate
        python scripts/smoke_api.py http://127.0.0.1:8000

    - name: Optional frontend build
      if: hashFiles('frontend/package-lock.json') != ''
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: npm
        cache-dependency-path: frontend/package-lock.json

    - name: Build frontend
      if: hashFiles('frontend/package-lock.json') != ''
      continue-on-error: true
      run: |
        npm ci --prefix frontend
        npm run build --prefix frontend || echo "Frontend build failed (non-blocking)"

    - name: Stop backend
      if: always()
      shell: bash
      run: |
        if [ -f /tmp/uvicorn.pid ]; then
          kill "$(cat /tmp/uvicorn.pid)" || true
        fi
