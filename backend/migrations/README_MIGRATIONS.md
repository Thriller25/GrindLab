# Alembic Migrations for GrindLab

This directory contains database schema migrations using SQLAlchemy and Alembic.

## Quick Start

### Apply all pending migrations to the database
```bash
cd backend
.\.venv\Scripts\alembic upgrade head
```

### Create a new migration
```bash
# Generate migration from model changes
.\.venv\Scripts\alembic revision --autogenerate -m "Description of changes"

# Or create an empty migration
.\.venv\Scripts\alembic revision -m "Manual migration name"
```

### Check current migration status
```bash
.\.venv\Scripts\alembic current
.\.venv\Scripts\alembic history
```

### Downgrade to previous migration
```bash
.\.venv\Scripts\alembic downgrade -1
```

## Configuration

- `alembic.ini` - Main Alembic configuration file
  - `sqlalchemy.url` - Database URL (overridden by `app.core.settings.settings.db_url`)
  - `revision_environment = true` - Enables running env.py during revision creation

- `env.py` - Alembic environment configuration
  - Automatically loads GrindLab models from `app.models`
  - Uses `app.core.settings.settings.db_url` if no URL specified in alembic.ini
  - Supports both offline and online migration modes

## Migration Files Structure

```
migrations/
├── README                    # This file
├── alembic.ini              # Alembic configuration
├── env.py                   # Alembic environment script
├── script.py.mako           # Migration template
└── versions/
    └── {revision}_{name}.py # Individual migration files
```

## Development Workflow

1. **Modify your models** in `app/models/`
2. **Create migration** with `alembic revision --autogenerate -m "description"`
3. **Review the generated migration** file in `versions/`
4. **Test locally** with `alembic upgrade head`
5. **Commit** both the migration file and model changes

## Production Deployment

1. **Deploy code** with new migration files
2. **Run migrations** with `alembic upgrade head`
3. **Monitor** migration execution in logs
4. **Verify** schema changes with migrations history: `alembic history`

## Notes

- Migrations are automatically generated using SQLAlchemy's autogenerate feature
- Each migration should be atomic (single logical change)
- Review autogenerated migrations carefully before committing
- Keep migrations in version control (git) with your code
- Never modify applied migrations (they're part of deployment history)
